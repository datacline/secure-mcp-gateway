# Notion MCP Server Setup Guide

## Issue
The Notion MCP server requires authentication but the bearer token was not configured, causing authentication failures.

## Solution

### Option 1: Disable Notion Server (Quick Fix)
The Notion server is now **disabled by default** in `mcp_servers.yaml`:

```yaml
notion:
  enabled: false  # Disabled - requires NOTION_MCP_BEARER_TOKEN to be set
```

This allows you to use other MCP servers without issues.

### Option 2: Configure Notion Authentication (For Production Use)

If you want to use the Notion MCP server:

#### Step 1: Get the Notion MCP Bearer Token

When you start the Notion MCP server with HTTP transport, it generates a bearer token:

```bash
# Start Notion MCP server (example)
npx -y @modelcontextprotocol/server-notion --transport http --port 8081
```

The server will output something like:
```
MCP server running on http://localhost:8081
Bearer token: mcp_Abc123XYZ...
```

#### Step 2: Set the Environment Variable

**IMPORTANT:** Export ONLY the token value, WITHOUT the "Bearer " prefix. The gateway will automatically add the prefix based on the configuration.

```bash
# CORRECT - Export just the token
export NOTION_MCP_BEARER_TOKEN="mcp_Abc123XYZ..."

# WRONG - Don't include "Bearer " in the environment variable
# export NOTION_MCP_BEARER_TOKEN="Bearer mcp_Abc123XYZ..."  # âŒ This will cause "Bearer Bearer ..." double prefix

# Or add to .env file (just the token)
echo "NOTION_MCP_BEARER_TOKEN=mcp_Abc123XYZ..." >> .env
```

**Why?** The `mcp_servers.yaml` configuration already specifies the prefix:
```yaml
auth:
  format: prefix
  prefix: "Bearer "  # <-- Gateway adds this automatically
  credential_ref: env://NOTION_MCP_BEARER_TOKEN
```

The gateway code will:
1. Read the token from `NOTION_MCP_BEARER_TOKEN`
2. Apply the prefix "Bearer " 
3. Create the header: `Authorization: Bearer mcp_Abc123XYZ...`

#### Step 3: Enable the Notion Server

Update `mcp_servers.yaml`:

```yaml
notion:
  url: http://localhost:8081/mcp
  type: http
  timeout: 60
  enabled: true  # Enable it
  description: "Notion MCP server for workspace integration"
  tags: ["notion", "productivity", "workspace"]
  tools: ["*"]
  auth:
    method: bearer
    location: header
    name: Authorization
    format: prefix
    prefix: "Bearer "
    credential_ref: env://NOTION_MCP_BEARER_TOKEN
```

#### Step 4: Restart the Gateway

```bash
# Stop the current gateway (Ctrl+C)
# Then restart
make dev
```

### Option 3: Use Without Authentication (Not Recommended)

If your Notion MCP server doesn't require authentication, you can remove the auth section:

```yaml
notion:
  url: http://localhost:8081/mcp
  type: http
  timeout: 60
  enabled: true
  description: "Notion MCP server"
  tags: ["notion"]
  tools: ["*"]
  auth: null  # No authentication
```

## Testing

Once configured, test the Notion integration:

```bash
# List all servers (should include notion if enabled)
curl http://localhost:8000/mcp/servers | jq

# List tools from Notion server
curl "http://localhost:8000/mcp/list-tools?mcp_server=notion" | jq

# Invoke a Notion tool
curl -X POST http://localhost:8000/mcp/invoke?mcp_server=notion \
  -H "Content-Type: application/json" \
  -d '{
    "tool_name": "search_workspace",
    "parameters": {"query": "test"}
  }' | jq
```

## Other MCP Servers

The gateway comes with other preconfigured servers:

### Default Mock Server
```bash
# Already configured and working
curl "http://localhost:8000/mcp/list-tools?mcp_server=default" | jq
```

### GitHub MCP Server
Requires `GITHUB_MCP_PAT` environment variable:

```bash
export GITHUB_MCP_PAT="your-github-token"
```

### Figma MCP Server
Requires configuration and authentication token.

## Troubleshooting

### Error: "Unauthorized: Missing bearer token"
- The `NOTION_MCP_BEARER_TOKEN` environment variable is not set
- Solution: Export the token or disable the server

### Error: "Connection refused"
- The Notion MCP server is not running
- Solution: Start the Notion MCP server or disable it in config

### Error: "MCP server 'notion' is disabled"
- The server is disabled in `mcp_servers.yaml`
- Solution: Set `enabled: true` and configure authentication

## Notes

- **NOTION_TOKEN**: This is the Notion API token (ntn_*) used BY the MCP server to access Notion
- **NOTION_MCP_BEARER_TOKEN**: This is the HTTP bearer token generated BY the MCP server for authentication
- These are two different tokens!

## Related Files

- `server-java/mcp_servers.yaml` - Server configuration
- `server-java/.env.example` - Environment variable examples
- `server-java/src/main/java/com/datacline/mcpgateway/service/McpProxyService.java` - Proxy logic with improved error handling
